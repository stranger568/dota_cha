_G.Quests_table =
{
	[1] = 
	{
		{ 1, "quest_kill_skeletons", 50, 500},
		{ 2, "quest_kill_kobolds", 35, 500},
		{ 3, "quest_kill_trolls", 30, 500},
		{ 4, "quest_kill_ghoul_assassins", 35, 500},
		{ 5, "quest_kill_ghost", 25, 500},
		{ 6, "quest_kill_harpy", 30, 500},
		{ 7, "quest_kill_crocodiles", 35, 500},
		{ 8, "quest_kill_hameleons", 35, 500},
		{ 9, "quest_kill_greevils", 50, 500},
		{ 10, "quest_kill_timber_spider", 25, 500},
		{ 11, "quest_kill_warpine_rider", 25, 500},
		{ 12, "quest_kill_banneling", 25, 500},
		{ 13, "quest_kill_giant_wolf", 25, 500},
		{ 14, "quest_kill_elf_wolf", 25, 500},
		{ 15, "quest_kill_satyrs", 50, 500},
		{ 16, "quest_kill_ogre", 50, 500},
		{ 17, "quest_kill_ogreseal", 20, 500},
		{ 18, "quest_kill_mud_golem", 20, 500},
		{ 19, "quest_kill_roshan", 1, 500},
		{ 20, "quest_kill_nian", 1, 500},
		{ 21, "quest_top_4", 1, 500},
		{ 22, "quest_duel_win_10", 10, 500},
		{ 23, "quest_deff_60", 1, 500},
		{ 24, "quest_bounty_pickup", 3, 500},
		{ 25, "quest_bet_30k", 30000, 500},
		--{ 26, "quest_deffing_smoke", 2, 500},
		{ 27, "quest_reroll_book", 4, 500},
		{ 28, "quest_tip_players", 5, 500},
		{ 29, "quest_book_13k", 1, 500},
		{ 30, "quest_deff_shiva", 150, 500},
		{ 31, "quest_abyssal_blade", 3, 500},
		{ 32, "quest_nullifier", 3, 500},
		{ 33, "quest_hex", 3, 500},
		{ 34, "quest_dagon", 5, 500},
		{ 35, "quest_orchid_bloodthorn", 5, 500},
		{ 36, "quest_ethereal_blade", 5, 500},
		{ 37, "quest_bloodstone",3 , 500},
		{ 38, "quest_refresher", 2, 500},
		{ 39, "quest_forget_rune", 5, 500},
		{ 40, "quest_blade_mail_kill_creeps", 50, 500},
		--{ 41, "quest_kill_summoners", 30, 500},
		{ 42, "quest_skills_upgrade_full", 1, 500},
		{ 43, "quest_smile_send", 1, 500},
		{ 44, "quest_chat_wheel_send", 1, 500},
	},
	[2] = 
	{
		{ 45, "quest_kill_granite_golem", 30, 1000},
		{ 46, "quest_kill_hellbear", 20, 1000},
		{ 47, "quest_kill_wildwings", 25, 1000},
		{ 48, "quest_kill_centaur", 35, 1000},
		{ 49, "quest_kill_toxin_spider", 25, 1000},
		{ 50, "quest_kill_dark_troll", 25, 1000},
		{ 51, "quest_kill_dragon", 25, 1000},
		{ 52, "quest_kill_thunder_lizrds", 25, 1000},
		{ 53, "quest_kill_ancient_prowlers", 25, 1000},
		{ 54, "quest_kill_frostbitten", 25, 1000},
		{ 55, "quest_kill_siltbreaker", 25, 1000},
		{ 56, "quest_kill_roshling", 25, 1000},
		{ 57, "quest_kill_bosses", 3, 1000},
		{ 58, "quest_top_2", 1, 1000},
		--{ 59, "quest_duel_x2", 1, 1000},
		{ 60, "quest_hellmask", 1, 1000},
		--{ 61, "quest_bloodstone_stacks", 25, 1000},
		{ 62, "quest_oneshot", 10, 1000},
		{ 63, "quest_duel_win_35", 35, 1000},
		{ 64, "quest_deff_80", 1, 1000},
		{ 65, "quest_boss_20sec", 1, 1000},
		--{ 66, "quest_gold_reach", 15000, 1000},
		{ 67, "quest_bet_50k", 50000, 1000},
		{ 68, "quest_reroll_10", 10, 1000},
		{ 69, "quest_tip_me_10", 10, 1000},
		{ 70, "quest_book_30k", 1, 1000},
		{ 71, "quest_duel_win_15sec", 1, 1000},
		{ 72, "quest_shiva_250creeps", 250, 1000},
		{ 73, "quest_aegis_buy", 1, 1000},
		{ 74, "quest_kill_with_dagon", 2, 1000},
	},
	[3] = 
	{
		--{ 75, "quest_pereves_5k", 1, 2000},
		--{ 76, "quest_no_death", 1, 2000},
		--{ 77, "quest_top_2_no_smoke", 1, 2000},
		{ 78, "quest_hell_mask_400", 1, 2000},
		{ 79, "quest_top1", 2, 2000},
		{ 80, "quest_duel_win_60", 60, 2000},
		{ 81, "quest_deff_10", 1, 2000},
		{ 82, "quest_bet_100k", 100000, 2000},
		--{ 83, "quest_kill_with_rubick_skill", 1, 2000},
		{ 84, "quest_one_shot_30", 30, 2000},
		{ 85, "quest_curse", 1, 2000},
		{ 86, "quest_duel_6sec", 1, 2000},
		--{ 87, "quest_50k_inventory", 1, 2000},
		{ 88, "quest_networth_150k", 1, 2000},
		{ 89, "quest_fingerdeath_40_one_game", 1, 2000},
		{ 90, "quest_laguna_blade_40_one_game", 1, 2000},
		{ 91, "quest_culling_blade_40_one_game", 1, 2000},
		{ 92, "quest_glaives_500_one_game", 1, 2000},
		{ 93, "quest_essenec_shift_400_one_game", 1, 2000},
		--{ 94, "quest_reaper_scythe_30_one_game", 1, 2000},
		{ 95, "quest_boss_10sec", 1, 2000},
	},
}

CustomNetTables:SetTableValue('quests_table', "tier_1", {quest = Quests_table[1]})
CustomNetTables:SetTableValue('quests_table', "tier_2", {quest = Quests_table[2]})
CustomNetTables:SetTableValue('quests_table', "tier_3", {quest = Quests_table[3]})

Quests_arena = class({})

function Quests_arena:CheckQuest(id, quest_tier, current, steamid)
	if current == nil then
		return Quests_arena:GiveRandomQuest(quest_tier, id, steamid)
	end
	return current
end

function Quests_arena:GiveRandomQuest(tier, id, steamid)
	local new_quest = Quests_table[tier][RandomInt(1, #Quests_table[tier])]
	local new_quest_info = {}
	new_quest_info["quest_tier"] = tostring(tier)
	new_quest_info["quest_number"] = tostring(new_quest[1])
	new_quest_info["current_point"] = tostring(0)
	new_quest_info["quest_active"] = tostring(1)
	ChaServerData.AddQuest(steamid, new_quest[1], tier)
	return new_quest_info
end

function Quests_arena:ChangeQuest(data)
	local tier = data.tier
	local id = data.PlayerID
	local quest_id = data.quest_id

	local quest_list_copy = table.deepcopy(Quests_table[tier]) 

	for i,v in ipairs(quest_list_copy) do
        if v[1] == tonumber(quest_id) then
            table.remove(quest_list_copy, i)
        end
    end

	local new_quest = quest_list_copy[RandomInt(1, #quest_list_copy)]

	local new_quest_info = {}
	new_quest_info["quest_tier"] = tostring(tier)
	new_quest_info["quest_number"] = tostring(new_quest[1])
	new_quest_info["current_point"] = tostring(0)
	new_quest_info["quest_active"] = tostring(1)

	local player_table = CustomNetTables:GetTableValue('cha_server_data', tostring(id))
  	
  	if player_table then
  		if tonumber(tier) == 1 then
  			player_table.quest_1 = new_quest_info
  			player_table.quest_swap1 = 1
  		end
  		if tonumber(tier) == 2 then
  			player_table.quest_2 = new_quest_info
  			player_table.quest_swap2 = 1
  		end
  		if tonumber(tier) == 3 then
  			player_table.quest_3 = new_quest_info
  			player_table.quest_swap3 = 1
  		end
  		CustomNetTables:SetTableValue('cha_server_data', tostring(id), player_table)
  	end

  	if ChaServerData.PLAYERS_GLOBAL_INFORMATION[id] then
		if tonumber(tier) == 1 then
  			ChaServerData.PLAYERS_GLOBAL_INFORMATION[id].quest_1 = new_quest_info
  			ChaServerData.PLAYERS_GLOBAL_INFORMATION[id].quest_swap1 = 1
  		end
  		if tonumber(tier) == 2 then
  			ChaServerData.PLAYERS_GLOBAL_INFORMATION[id].quest_2 = new_quest_info
  			ChaServerData.PLAYERS_GLOBAL_INFORMATION[id].quest_swap2 = 1
  		end
  		if tonumber(tier) == 3 then
  			ChaServerData.PLAYERS_GLOBAL_INFORMATION[id].quest_3 = new_quest_info
  			ChaServerData.PLAYERS_GLOBAL_INFORMATION[id].quest_swap3 = 1
  		end
  	end

  	ChaServerData.ChangeQuestSend(id, tier, new_quest[1], 1)
end

function Quests_arena:ChangeQuestComplete(data)
	local tier = data.tier
	local id = data.PlayerID
	local quest_id = data.quest_id

	print("change quest info", tier, id, quest_id)

	local quest_list_copy = table.deepcopy(Quests_table[tier]) 

	for i,v in ipairs(quest_list_copy) do
        if v[1] == tonumber(quest_id) then
            table.remove(quest_list_copy, i)
        end
    end

	local new_quest = quest_list_copy[RandomInt(1, #quest_list_copy)]

	local new_quest_info = {}
	new_quest_info["quest_tier"] = tostring(tier)
	new_quest_info["quest_number"] = tostring(new_quest[1])
	new_quest_info["current_point"] = tostring(0)
	new_quest_info["quest_active"] = tostring(1)

	local player_table = CustomNetTables:GetTableValue('cha_server_data', tostring(id))
  	
  	if player_table then
  		if tonumber(tier) == 1 then
  			player_table.quest_1 = new_quest_info
  		end
  		if tonumber(tier) == 2 then
  			player_table.quest_2 = new_quest_info
  		end
  		if tonumber(tier) == 3 then
  			player_table.quest_3 = new_quest_info
  		end
  		CustomNetTables:SetTableValue('cha_server_data', tostring(id), player_table)
  	end

  	if ChaServerData.PLAYERS_GLOBAL_INFORMATION[id] then
		if tonumber(tier) == 1 then
  			ChaServerData.PLAYERS_GLOBAL_INFORMATION[id].quest_1 = new_quest_info
  		end
  		if tonumber(tier) == 2 then
  			ChaServerData.PLAYERS_GLOBAL_INFORMATION[id].quest_2 = new_quest_info
  		end
  		if tonumber(tier) == 3 then
  			ChaServerData.PLAYERS_GLOBAL_INFORMATION[id].quest_3 = new_quest_info
  		end
  	end

  	ChaServerData.ChangeQuestSend(id, tier, new_quest[1], 0)
end

function Quests_arena:QuestProgress(player_id, quest_id, tier, lcount)
	local player_table = CustomNetTables:GetTableValue('cha_server_data', tostring(player_id))
	if player_table then
		if tonumber(tier) == 1 then
			if player_table.quest_1 then
				if player_table.quest_1.quest_number and tonumber(player_table.quest_1.quest_number) == tonumber(quest_id) and tonumber(player_table.quest_1.quest_active) == 1 then

					local quest_information = Quests_arena:FindQuestInformation(quest_id, tier)

					if tonumber(player_table.quest_1.current_point) < quest_information[3] then
						if lcount ~= nil then
							player_table.quest_1.current_point = tonumber(player_table.quest_1.current_point) + lcount
						else
							player_table.quest_1.current_point = tonumber(player_table.quest_1.current_point) + 1
						end
					end

					if tonumber(player_table.quest_1.current_point) >= quest_information[3] then
						player_table.quest_1.quest_active = 0
						player_table.quest_complete1 = player_table.quest_complete1 + 1

						player_table = Quests_arena:UpdateArenaLevel(tonumber(quest_information[4]), player_id, player_table)

						Timers:CreateTimer(2, function()
							if (player_table.pass_level_1_days > 0 or player_table.pass_level_2_days > 0 or player_table.pass_level_3_days > 0) and player_table.quest_complete1 < 2 then
								Quests_arena:ChangeQuestComplete({ tier = tier, PlayerID = player_id, quest_id = quest_id })
							else
								ChaServerData.CloseQuest(player_id, quest_id, tier)
							end
						end)
					end

					CustomNetTables:SetTableValue('cha_server_data', tostring(player_id), player_table)
				end
			end
			return
		end
		if tonumber(tier) == 2 then
			if player_table.quest_2 then
				if player_table.quest_2.quest_number and tonumber(player_table.quest_2.quest_number) == tonumber(quest_id) and tonumber(player_table.quest_2.quest_active) == 1 then

					local quest_information = Quests_arena:FindQuestInformation(quest_id, tier)

					if tonumber(player_table.quest_2.current_point) < quest_information[3] then
						if lcount ~= nil then
							player_table.quest_2.current_point = tonumber(player_table.quest_2.current_point) + lcount
						else
							player_table.quest_2.current_point = tonumber(player_table.quest_2.current_point) + 1
						end
					end

					if tonumber(player_table.quest_2.current_point) >= quest_information[3] then
						player_table.quest_2.quest_active = 0
						player_table.quest_complete2 = player_table.quest_complete2 + 1

						player_table = Quests_arena:UpdateArenaLevel(tonumber(quest_information[4]), player_id, player_table)

						Timers:CreateTimer(2, function()
							if (player_table.pass_level_2_days > 0 or player_table.pass_level_3_days > 0) and player_table.quest_complete2 < 2 then
								Quests_arena:ChangeQuestComplete({ tier = tier, PlayerID = player_id, quest_id = quest_id })
							else
								ChaServerData.CloseQuest(player_id, quest_id, tier)
							end
						end)
					end

					CustomNetTables:SetTableValue('cha_server_data', tostring(player_id), player_table)
				end
			end
			return
		end
		if tonumber(tier) == 3 then
			if player_table.quest_3 then
				if player_table.quest_3.quest_number and tonumber(player_table.quest_3.quest_number) == tonumber(quest_id) and tonumber(player_table.quest_3.quest_active) == 1 then

					local quest_information = Quests_arena:FindQuestInformation(quest_id, tier)

					if tonumber(player_table.quest_3.current_point) < quest_information[3] then
						if lcount ~= nil then
							player_table.quest_3.current_point = tonumber(player_table.quest_3.current_point) + lcount
						else
							player_table.quest_3.current_point = tonumber(player_table.quest_3.current_point) + 1
						end
					end

					if tonumber(player_table.quest_3.current_point) >= quest_information[3] then
						player_table.quest_3.quest_active = 0
						player_table.quest_complete3 = player_table.quest_complete3 + 1

						player_table = Quests_arena:UpdateArenaLevel(tonumber(quest_information[4]), player_id, player_table)

						Timers:CreateTimer(2, function()
							if (player_table.pass_level_3_days > 0) and player_table.quest_complete3 < 2 then
								Quests_arena:ChangeQuestComplete({ tier = tier, PlayerID = player_id, quest_id = quest_id })
							else
								ChaServerData.CloseQuest(player_id, quest_id, tier)
							end
						end)
					end

					CustomNetTables:SetTableValue('cha_server_data', tostring(player_id), player_table)
				end
			end
			return
		end
	end
end

function Quests_arena:UpdateArenaLevel(count, id, player_table)
	local old_level = math.floor(player_table.arena_level / 1000)
	player_table.arena_level = player_table.arena_level + count
	local new_level = math.floor(player_table.arena_level / 1000)
	local bonus_donate_coin = 0
	local bonus_arena_coin = 0
	if new_level > old_level then
		local mult = new_level - old_level
		bonus_donate_coin = 3 * mult
		bonus_arena_coin = 20 * mult
	end
	player_table.game_coin = player_table.game_coin + bonus_arena_coin
	player_table.donate_coin = player_table.donate_coin + bonus_donate_coin
	ChaServerData.GetNewExpLevel(id, count, bonus_donate_coin, bonus_arena_coin)
	return player_table
end

function Quests_arena:FindQuestInformation(quest_id, tier)
	if Quests_table[tier] then
		for _, info in pairs(Quests_table[tier]) do
			if tonumber(info[1]) == tonumber(quest_id) then
				return info
			end
		end
	end
end

